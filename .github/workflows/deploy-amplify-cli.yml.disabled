name: Deploy with Amplify CLI

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    name: Deploy to AWS Amplify
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Install AWS Amplify CLI
      run: npm install -g @aws-amplify/cli@latest
    
    - name: Configure AWS credentials
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set default.region us-east-1
        aws configure set default.output json
    
    - name: Initialize Amplify project (if needed)
      run: |
        if [ ! -f "amplify/.config/project-config.json" ]; then
          echo "Initializing new Amplify project..."
          amplify init --yes
        else
          echo "Amplify project already initialized"
        fi
      continue-on-error: true
    
    - name: Add hosting (if needed)
      run: |
        if ! amplify status | grep -q "hosting"; then
          echo "Adding hosting to Amplify project..."
          amplify add hosting --automated
        else
          echo "Hosting already configured"
        fi
      continue-on-error: true
    
    - name: Deploy to Amplify
      run: |
        echo "Publishing to Amplify..."
        amplify publish --yes
      continue-on-error: true
    
    - name: Show deployment status
      run: |
        echo "Deployment completed!"
        echo "If deployment failed, check the following:"
        echo "1. Ensure AWS credentials are properly configured"
        echo "2. Verify Amplify project is initialized"
        echo "3. Check if hosting is properly configured"
        echo "Build output is available in the dist/ directory"
        ls -la dist/
